<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Hyrox Ä°stanbul Analiz</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;400;500;600;700&family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #0f1115;
      --bg-card: #161920;
      --accent: #fbbf24; /* Hyrox Yellow */
      --text: #ffffff;
      --text-soft: #9ca3af;
      --border: #2a2f3a;
      --danger: #ef4444;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding-bottom: 50px;
    }

    /* HEADER */
    header {
      background: #000;
      border-bottom: 2px solid var(--accent);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    .brand { font-family: 'Teko', sans-serif; font-size: 28px; font-weight: 600; text-transform: uppercase; }
    .brand span { color: var(--accent); }
    .status { font-size: 12px; color: var(--text-soft); background: #222; padding: 4px 8px; border-radius: 4px; }

    /* LAYOUT */
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    .grid-top {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    /* KPI CARDS */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }
    .card-label { font-size: 11px; text-transform: uppercase; color: var(--text-soft); letter-spacing: 1px; margin-bottom: 5px; }
    .card-val { font-family: 'Teko', sans-serif; font-size: 32px; font-weight: 600; line-height: 1; }
    .c-yellow { color: var(--accent); }
    .c-blue { color: #3b82f6; }
    .c-pink { color: #ec4899; }
    
    /* FILTERS */
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-soft);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: 0.2s;
    }
    .btn:hover { background: #222; color: #fff; }
    .btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

    /* CHARTS */
    .chart-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .chart-header { font-size: 16px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
    .chart-box { position: relative; height: 350px; width: 100%; }

    /* ERROR BOX */
    #errorLog {
      display: none;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--danger);
      color: #fca5a5;
      padding: 15px;
      margin-top: 20px;
      border-radius: 8px;
      font-size: 13px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<header>
  <div class="brand">HYROX <span>ISTANBUL</span></div>
  <div class="status" id="lastUpdate">Veriler yÃ¼kleniyor...</div>
</header>

<div class="container">

  <div class="grid-top">
    <div class="card">
      <div class="card-label">Toplam Kalan</div>
      <div class="card-val c-yellow" id="kpiTotal">-</div>
    </div>
    <div class="card">
      <div class="card-label">Erkek</div>
      <div class="card-val c-blue" id="kpiMen">-</div>
    </div>
    <div class="card">
      <div class="card-label">KadÄ±n</div>
      <div class="card-val c-pink" id="kpiWomen">-</div>
    </div>
    <div class="card">
      <div class="card-label">Doubles / Mixed</div>
      <div class="card-val" id="kpiTeam">-</div>
    </div>
  </div>

  <div class="controls">
    <button class="btn active" onclick="setFilter('ALL')">TÃœMÃœ</button>
    <button class="btn" onclick="setFilter('MEN')">ERKEK (MEN)</button>
    <button class="btn" onclick="setFilter('WOMEN')">KADIN (WOMEN)</button>
    <button class="btn" onclick="setFilter('DOUBLES')">Ã‡Ä°FTLÄ° (DOUBLES)</button>
    <button class="btn" onclick="setFilter('MIXED')">MIXED</button>
  </div>

  <div class="chart-section">
    <div class="chart-header">ðŸ“Š GÃ¼ncel Stok Durumu (Son Veri)</div>
    <div class="chart-box">
      <canvas id="chartCurrent"></canvas>
    </div>
  </div>

  <div class="chart-section">
    <div class="chart-header">ðŸ“ˆ SatÄ±ÅŸ Trendi (Zaman Ã‡izelgesi)</div>
    <div class="chart-box">
      <canvas id="chartHistory"></canvas>
    </div>
  </div>

  <div id="errorLog"></div>

</div>

<script>
/* --- AYARLAR --- */
const CONFIG = {
  dataDir: "data",
  startDate: "03.01.2026" // BaÅŸlangÄ±Ã§ tarihi (DD.MM.YYYY)
};

/* --- GLOBAL VERÄ° HAVUZU --- */
let HISTORY = []; // TÃ¼m gÃ¼nlerin verisi burada toplanacak
let LATEST = null; // En son gÃ¼nÃ¼n verisi
let currentFilter = 'ALL';

/* --- CHART INSTANCES --- */
let charts = { current: null, history: null };

/* --- YARDIMCI FONKSÄ°YONLAR --- */
const pad = n => String(n).padStart(2, "0");
const strToDate = s => {
  const [d,m,y] = s.split(".").map(Number);
  return new Date(y, m-1, d);
};
const dateToStr = d => `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };

/* --- VERÄ° OKUMA MOTORU --- */
// Bu fonksiyon "Brute Force" yÃ¶ntemiyle Ã§alÄ±ÅŸÄ±r.
// BaÅŸlangÄ±Ã§ tarihinden bugÃ¼ne kadar olasÄ± tÃ¼m dosya isimlerini (03.01.2026.json, 04.01.2026.json...)
// tek tek dener. HTML dÃ¶nerse veya 404 verirse sessizce atlar.
async function fetchAllData() {
  const start = strToDate(CONFIG.startDate);
  const now = new Date();
  const validData = [];
  
  // BugÃ¼ne kadar (+1 gÃ¼n gÃ¼venlik payÄ±) dÃ¶ngÃ¼ kur
  let curr = start;
  // Sonsuz dÃ¶ngÃ¼den kaÃ§Ä±nmak iÃ§in max 60 gÃ¼n ileri gitsin
  let safetyLimit = 0;
  
  while(curr <= addDays(now, 1) && safetyLimit < 60) {
    const fileName = `${dateToStr(curr)}.json`;
    const url = `${CONFIG.dataDir}/${fileName}?ts=${Date.now()}`; // Cache busting
    
    try {
      const res = await fetch(url);
      
      // Kilit Nokta: Sadece status 200 VE Content-Type JSON ise iÅŸle
      const cType = res.headers.get("content-type");
      if(res.ok && cType && cType.includes("application/json")) {
        const json = await res.json();
        
        // Veriyi iÅŸle ve listeye ekle
        if(json.tickets) {
          validData.push({
            date: dateToStr(curr),
            objDate: new Date(curr),
            tickets: processTickets(json.tickets)
          });
        }
      }
    } catch(err) {
      // Dosya yoksa veya hata varsa atla, konsola basma
    }
    
    curr = addDays(curr, 1);
    safetyLimit++;
  }

  if(validData.length === 0) throw new Error("HiÃ§bir geÃ§erli JSON dosyasÄ± bulunamadÄ±.");
  
  // Tarihe gÃ¶re sÄ±rala
  validData.sort((a,b) => a.objDate - b.objDate);
  
  HISTORY = validData;
  LATEST = validData[validData.length - 1]; // En son veri
}

// Biletleri etiketle (Tagging)
function processTickets(rawTickets) {
  return rawTickets.map(t => {
    const name = t.ticket.toUpperCase();
    const tags = [];
    
    if(name.includes("MEN") && !name.includes("WOMEN")) tags.push("MEN");
    if(name.includes("WOMEN")) tags.push("WOMEN");
    if(name.includes("MIXED")) tags.push("MIXED");
    if(name.includes("DOUBLES")) tags.push("DOUBLES");
    
    return {
      name: t.ticket.replace("HYROX ", ""), // Grafiklerde yer kaplamasÄ±n diye kÄ±salttÄ±k
      stock: t.stock,
      tags: tags
    };
  });
}

/* --- GRAFÄ°K VE UI GÃœNCELLEME --- */

function updateDashboard() {
  if(!LATEST) return;

  // 1. Header Bilgisi
  document.getElementById("lastUpdate").textContent = `Son Veri: ${LATEST.date} (${HISTORY.length} gÃ¼n)`;

  // 2. KPI Hesapla (Filtreden baÄŸÄ±msÄ±z genel toplam)
  let kpi = { total:0, men:0, women:0, team:0 };
  LATEST.tickets.forEach(t => {
    kpi.total += t.stock;
    if(t.tags.includes("MEN")) kpi.men += t.stock;
    if(t.tags.includes("WOMEN")) kpi.women += t.stock;
    if(t.tags.includes("DOUBLES") || t.tags.includes("MIXED")) kpi.team += t.stock;
  });
  
  document.getElementById("kpiTotal").textContent = kpi.total.toLocaleString();
  document.getElementById("kpiMen").textContent = kpi.men.toLocaleString();
  document.getElementById("kpiWomen").textContent = kpi.women.toLocaleString();
  document.getElementById("kpiTeam").textContent = kpi.team.toLocaleString();

  // 3. Grafikleri Ã‡iz
  drawCurrentChart();
  drawHistoryChart();
}

function filterData(ticketList) {
  if(currentFilter === 'ALL') return ticketList;
  // SeÃ§ilen filtre ticket'Ä±n tags dizisinde var mÄ±?
  return ticketList.filter(t => t.tags.includes(currentFilter));
}

// Grafik 1: GÃ¼ncel Durum (Bar)
function drawCurrentChart() {
  const ctx = document.getElementById("chartCurrent").getContext("2d");
  const filtered = filterData(LATEST.tickets);
  
  // Stok sayÄ±sÄ±na gÃ¶re sÄ±rala
  filtered.sort((a,b) => b.stock - a.stock);

  const labels = filtered.map(t => t.name);
  const data = filtered.map(t => t.stock);
  const colors = data.map(v => v < 50 ? '#ef4444' : (v < 150 ? '#f59e0b' : '#10b981'));

  if(charts.current) charts.current.destroy();

  charts.current = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Adet',
        data: data,
        backgroundColor: colors,
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: '#2a2f3a' }, ticks: { color: '#9ca3af' } },
        y: { grid: { display: false }, ticks: { color: '#fff', font: {size: 11} } }
      }
    }
  });
}

// Grafik 2: TarihÃ§e (Line)
function drawHistoryChart() {
  const ctx = document.getElementById("chartHistory").getContext("2d");
  
  // X Ekseni: Tarihler
  const labels = HISTORY.map(h => h.date.substring(0, 5)); // "03.01" formatÄ±
  
  // Dataset oluÅŸturma mantÄ±ÄŸÄ±:
  // Filtreye uyan tÃ¼m UNIQ bilet isimlerini bul
  const allTicketNames = new Set();
  HISTORY.forEach(day => {
    filterData(day.tickets).forEach(t => allTicketNames.add(t.name));
  });

  const datasets = Array.from(allTicketNames).map((tName, index) => {
    // Her gÃ¼n iÃ§in bu biletin stoÄŸunu bul
    const dataPoints = HISTORY.map(day => {
      const found = day.tickets.find(t => t.name === tName);
      return found ? found.stock : null; // O gÃ¼n bilet yoksa null (Ã§izgi kopuk olur) veya 0
    });

    // Renk paleti (DÃ¶ngÃ¼sel)
    const palette = ['#3b82f6', '#ef4444', '#fbbf24', '#10b981', '#ec4899', '#8b5cf6', '#f97316'];
    const color = palette[index % palette.length];

    return {
      label: tName,
      data: dataPoints,
      borderColor: color,
      backgroundColor: color,
      tension: 0.3,
      borderWidth: 2,
      pointRadius: 3,
      pointHoverRadius: 6
    };
  });

  if(charts.history) charts.history.destroy();

  charts.history = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: '#9ca3af', boxWidth: 10 } },
        tooltip: { 
          backgroundColor: '#161920', 
          titleColor: '#fff', 
          bodyColor: '#ccc',
          borderColor: '#333',
          borderWidth: 1
        }
      },
      scales: {
        x: { grid: { color: '#2a2f3a' }, ticks: { color: '#9ca3af' } },
        y: { grid: { color: '#2a2f3a' }, ticks: { color: '#9ca3af' } }
      }
    }
  });
}

/* --- INIT & CONTROLS --- */
window.setFilter = (type) => {
  currentFilter = type;
  // Buton class gÃ¼ncelle
  document.querySelectorAll('.btn').forEach(b => {
    b.classList.toggle('active', b.innerText.includes(type) || (type==='ALL' && b.innerText==='TÃœMÃœ'));
  });
  updateDashboard();
};

(async function init() {
  try {
    await fetchAllData();
    updateDashboard();
  } catch(err) {
    const el = document.getElementById("errorLog");
    el.style.display = "block";
    el.textContent = "HATA: " + err.message + "\nLÃ¼tfen 'data' klasÃ¶rÃ¼nde en az bir tane 'GG.AA.YYYY.json' formatÄ±nda dosya olduÄŸundan emin olun.";
  }
})();
</script>

</body>
</html>
